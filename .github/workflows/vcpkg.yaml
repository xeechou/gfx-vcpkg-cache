name: vcpkg-ci-build
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      # immediately cancel all other jobs if one fails. Don't waste quotas, windows CI runs really long
      fail-fast: true

      # setup
      # test one platform at a time

      # NOTE: based off
      #       https://docs.github.com/en/billing/concepts/product-billing/github-actions#minute-multipliers
      #       The multiplier for MacOS is 10, very expensive. So the Mac CI is
      #       disabled here. Since I only have 2000 minutes per month.

      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        c_compiler: [gcc, cl, clang]
        include:
          - os: windows-latest
            vcpkgCommitId: '05442024c3fda64320bd25d2251cc9807b84fb6f'
            triplet: 'x64-windows'
            configPreset: 'vcpkg-win32'
            buildPreset:  'vcpkg-win32'
          - os: ubuntu-latest
            vcpkgCommitId: '05442024c3fda64320bd25d2251cc9807b84fb6f'
            triplet: 'x64-linux'
            configPreset: 'vcpkg'
            buildPreset:  'vcpkg-unix'
          - os: macos-latest
            triplet: 'arm64-osx'
            vcpkgCommitId: '05442024c3fda64320bd25d2251cc9807b84fb6f'
            configPreset: 'vcpkg'
            buildPreset:  'vcpkg-unix'
        exclude:
          - os: windows-latest
            c_compiler: gcc
          - os: windows-latest
            c_compiler: clang
          - os: ubuntu-latest
            c_compiler: cl
          - os: ubuntu-latest
            c_compiler: clang
          - os: macos-latest
            c_compiler:  'gcc'
          - os: macos-latest
            c_compiler:  'cl'

    steps:
      - name: Check out branch
        uses: actions/checkout@v4
        with:
          submodules: true
          lfs: true

      - name: Get CMake
        uses: lukka/get-cmake@v3.28.0

      - name: Linux Platform tools
        if: matrix.os == 'ubuntu-latest'
        # required packages on Linux for vcpkg install to succeed
        run: |
          sudo apt update;
          sudo apt install -y python3 curl zip unzip git
          sudo apt install -y g++ gcc pkg-config make
          sudo apt install -y libtool libltdl-dev ninja-build
          sudo apt install -y libxcb1-dev libx11-dev libxft-dev libxext-dev libxrandr-dev libxt-dev
          sudo apt install -y libwayland-dev libxkbcommon-dev libegl1-mesa-dev libibus-1.0-dev
          sudo apt install -y mesa-vulkan-drivers libvulkan1 vulkan-tools vulkan-validationlayers
          sudo apt install -y autoconf autoconf-archive automake libtool

      #run-cmake@10 cache currently does not work. We have to do this
      #manually, see https://github.com/lukka/run-cmake/issues/152
      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/vcpkg_cache
          # some additional file hash can be aded later: 'vcpkg_overlay/**',
          # 'CMakeLists.txt', '**/CMakeLists.txt', but now we just need vcpkg.json
          key: vcpkg-${{ matrix.vcpkgCommitId }}-${{ matrix.triplet }}-${{ hashFiles('vcpkg.json') }}
          ## restore keys seemed to be needed for getting back the caches. See
          ## https://github.com/orgs/community/discussions/27059
          restore-keys: |
              vcpkg-${{ matrix.vcpkgCommitId }}-${{ matrix.triplet }}-${{ hashFiles('vcpkg.json') }}
              vcpkg-${{ matrix.vcpkgCommitId }}-${{ matrix.triplet }}-

      - name: Setup a new (or from cache) vcpkg (and does not build any package)
        uses: lukka/run-vcpkg@v11 # Always specify the specific _version_ of the
                                  # action you need, `v11` in this case to stay up
                                  # to date with fixes on the v11 branch.
        with:
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          vcpkgGitCommitId: '${{ matrix.vcpkgCommitId }}'
          # testing for vcpkg install. Don't need it normally
          runVcpkgInstall: true
          # The vcpkg.json file, which will be part of cache key computation.
          vcpkgJsonGlob: '**/vcpkg.json'
        env:
          VCPKG_BINARY_SOURCES: clear;files,${{ github.workspace }}/vcpkg_cache,readwrite
      # - name: list directory
      #   shell: bash
      #   run: ls -la '${{ github.workspace }}/vcpkg_cache'

      - name: Package vcpkg cache
        shell: bash                                               #quote is needed here for windows
        run: tar -czf vcpkg-cache-${{ matrix.triplet }}.tar.gz -C '${{ github.workspace }}' vcpkg_cache 

      - name: Upload vcpkg cache artifact
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-cache-${{ matrix.triplet }}
          path: vcpkg-cache-${{ matrix.triplet }}.tar.gz
          retention-days: 90

  release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create release tag
        id: tag
        run: echo "tag=vcpkg-cache-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "vcpkg cache ${{ steps.tag.outputs.tag }}"
          body: |
            Automated vcpkg cache build from commit ${{ github.sha }}.

            Contains pre-built vcpkg packages for:
            - `x64-windows`
            - `x64-linux`
            - `arm64-osx`
          files: artifacts/*.tar.gz
          generate_release_notes: false
