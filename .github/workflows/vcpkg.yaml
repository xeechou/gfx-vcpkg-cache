name: vcpkg-ci-build
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      # immediately cancel all other jobs if one fails. Don't waste quotas, windows CI runs really long
      fail-fast: true

      # setup
      # test one platform at a time

      # NOTE: based off
      #       https://docs.github.com/en/billing/concepts/product-billing/github-actions#minute-multipliers
      #       The multiplier for MacOS is 10, very expensive. So the Mac CI is
      #       disabled here. Since I only have 2000 minutes per month.

      matrix:
        os: [ubuntu-24.04, windows-2025, macos-15]  #we should fix the os-variant rather than use -latest
        c_compiler: [gcc, cl, clang]
        include:
          - os: windows-2025
            vcpkgCommitId: '05442024c3fda64320bd25d2251cc9807b84fb6f'
            triplet: 'x64-windows'
            configPreset: 'vcpkg-win32'
            buildPreset:  'vcpkg-win32'
          - os: ubuntu-24.04
            vcpkgCommitId: '05442024c3fda64320bd25d2251cc9807b84fb6f'
            triplet: 'x64-linux'
            configPreset: 'vcpkg'
            buildPreset:  'vcpkg-unix'
          - os: macos-15
            triplet: 'arm64-osx'
            vcpkgCommitId: '05442024c3fda64320bd25d2251cc9807b84fb6f'
            configPreset: 'vcpkg'
            buildPreset:  'vcpkg-unix'
        exclude:
          - os: windows-2025
            c_compiler: gcc
          - os: windows-2025
            c_compiler: clang
          - os: ubuntu-24.04
            c_compiler: cl
          - os: ubuntu-24.04
            c_compiler: clang
          - os: macos-15
            c_compiler:  'gcc'
          - os: macos-15
            c_compiler:  'cl'

    steps:
      - name: Check out branch
        uses: actions/checkout@v4
        with:
          submodules: true
          lfs: true

      - name: Get CMake
        uses: lukka/get-cmake@v3.28.0

      - name: Linux Platform tools
        if: matrix.os == 'ubuntu-24.04'
        # required packages on Linux for vcpkg install to succeed, ubuntu image came with gcc/g++
        run: |
          sudo apt update;
          sudo apt install -y python3 curl zip unzip git
          sudo apt install -y pkg-config make
          sudo apt install -y libtool libltdl-dev ninja-build
          sudo apt install -y libxcb1-dev libx11-dev libxft-dev libxext-dev libxrandr-dev libxt-dev
          sudo apt install -y libwayland-dev libxkbcommon-dev libegl1-mesa-dev libibus-1.0-dev
          sudo apt install -y mesa-vulkan-drivers libvulkan1 vulkan-tools vulkan-validationlayers
          sudo apt install -y autoconf autoconf-archive automake libtool

      #run-cmake@10 cache currently does not work. We have to do this
      #manually, see https://github.com/lukka/run-cmake/issues/152
      - name: Hash vcpkg.json
        id: vcpkg-json-hash
        shell: bash
        run: echo "hash=$(sha256sum vcpkg.json | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/vcpkg_cache
          # some additional file hash can be aded later: 'vcpkg_overlay/**',
          # 'CMakeLists.txt', '**/CMakeLists.txt', but now we just need vcpkg.json
          key: vcpkg-${{ matrix.vcpkgCommitId }}-${{ matrix.triplet }}-${{ steps.vcpkg-json-hash.outputs.hash }}

          # we want the exact hash, otherwise we might combine multiple cache together, it would way too big
          restore-keys: |
            vcpkg-${{ matrix.vcpkgCommitId }}-${{ matrix.triplet }}-${{ steps.vcpkg-json-hash.outputs.hash }}

      - name: Setup a new (or from cache) vcpkg (and does not build any package)
        uses: lukka/run-vcpkg@v11 # Always specify the specific _version_ of the
                                  # action you need, `v11` in this case to stay up
                                  # to date with fixes on the v11 branch.
        with:
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          vcpkgGitCommitId: '${{ matrix.vcpkgCommitId }}'
          # testing for vcpkg install. Don't need it normally
          runVcpkgInstall: true
          # The vcpkg.json file, which will be part of cache key computation.
          vcpkgJsonGlob: '**/vcpkg.json'
        env:
          VCPKG_BINARY_SOURCES: clear;files,${{ github.workspace }}/vcpkg_cache,readwrite
          VCPKG_INSTALLED_DIR: '${{ github.workspace }}/vcpkg_installed'

      - name: Export vcpkg packages (standalone relocatable SDK)
        shell: bash
        run: |
          '${{ github.workspace }}/vcpkg/vcpkg' export \
            --x-all-installed \
            --x-install-root='${{ github.workspace }}/vcpkg_installed' \
            --raw --output-dir='${{ github.workspace }}' \
            --output=vcpkg-export-${{ matrix.triplet }}

      - name: Package vcpkg export
        shell: bash
        run: tar -cf - -C '${{ github.workspace }}' vcpkg-export-${{ matrix.triplet }} | zstd -19 -T0 -o vcpkg-export-${{ matrix.triplet }}.tar.zst

      - name: Upload vcpkg export artifact
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-export-${{ matrix.triplet }}
          path: vcpkg-export-${{ matrix.triplet }}.tar.zst
          retention-days: 90
  release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create release tag
        id: tag
        run: echo "tag=vcpkg-cache-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "vcpkg cache ${{ steps.tag.outputs.tag }}"
          body: |
            Automated vcpkg export build from commit ${{ github.sha }}.

            Contains pre-built vcpkg export packages for:
            - `x64-windows`
            - `x64-linux`
            - `arm64-osx`

            Each archive (`vcpkg-export-{triplet}.tar.zst`) is a standalone relocatable SDK
            for use with `CMAKE_TOOLCHAIN_FILE` and `-DVCPKG_MANIFEST_MODE=OFF`.
          files: artifacts/*.tar.zst
          generate_release_notes: false
