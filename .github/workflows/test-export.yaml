name: test-vcpkg-export
on:
  workflow_run:
    workflows: ["vcpkg-ci-build"]
    types: [completed]
    branches: [master]
  workflow_dispatch:

jobs:
  test-export:
    # Only run if the triggering workflow succeeded, or if manually dispatched
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            triplet: 'x64-linux'
            generator: 'Ninja'
          - os: windows-2025
            triplet: 'x64-windows'
            generator: 'Visual Studio 17'
          - os: macos-15
            triplet: 'arm64-osx'
            generator: 'Ninja'

    steps:
      - name: Check out branch
        uses: actions/checkout@v4

      - name: Get CMake and Ninja
        uses: lukka/get-cmake@v3.28.0
        with:
          ninjaVersion: latest

      - name: Linux dependencies
        if: matrix.os == 'ubuntu-24.04'
        run: |
          sudo apt update
          sudo apt install -y pkg-config
          sudo apt install -y libgl1-mesa-dev libglu1-mesa-dev
          sudo apt install -y libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev

      - name: Download vcpkg export
        shell: bash
        run: |
          gh release download \
            --pattern "vcpkg-export-${{ matrix.triplet }}.tar.zst" \
            --dir ${{ github.workspace }}
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Verify downloaded tarball exists
        shell: bash
        run: |
          echo "=== github.workspace = ${{ github.workspace }} ==="
          echo "=== pwd ==="
          pwd
          echo "=== ls -la \${{ github.workspace }} ==="
          ls -la "${{ github.workspace }}"
          echo "=== looking for vcpkg-export-${{ matrix.triplet }}.tar.zst ==="
          ls -la "${{ github.workspace }}/vcpkg-export-${{ matrix.triplet }}.tar.zst" || echo "FILE NOT FOUND!"
          file "${{ github.workspace }}/vcpkg-export-${{ matrix.triplet }}.tar.zst" || true

      - name: Extract vcpkg export
        shell: bash
        working-directory: ${{ github.workspace }}
        run: tar -axf vcpkg-export-${{ matrix.triplet }}.tar.zst

      - name: Configure CMake
        shell: bash
        run: |
          cmake -B build -S . -G ${{ matrix.generator }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg-export-${{ matrix.triplet }}/scripts/buildsystems/vcpkg.cmake \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/vcpkg-export-${{ matrix.triplet }}/installed/${{ matrix.triplet }}


      - name: Build
        run: cmake --build build --config Release

      - name: Verify executable exists
        shell: bash
        run: |
          if [ "${{ matrix.os }}" == "windows-2025" ]; then
            ls -la build/Release/testusd.exe
          else
            ls -la build/testusd
          fi
